<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CONFIIA Study: Medical Decision Dynamics</title>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; }
        
        /* Main Card Style */
        .medical-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            max-width: 750px;
            margin: 30px auto;
            padding: 40px;
            text-align: left;
            border-top: 5px solid #2c3e50; /* Dark Clinical Blue */
        }

        h1 { color: #2c3e50; font-weight: 300; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-top: 0; }
        h2 { color: #34495e; font-size: 1.4em; margin-bottom: 20px; }
        h3 { color: #2c3e50; margin-top: 25px; font-size: 1.2em;}
        
        .highlight-box {
            background-color: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.95em;
            border-radius: 0 4px 4px 0;
        }

        .warning-box {
            background-color: #fff3cd; 
            border-left: 4px solid #f1c40f;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.95em;
        }

        .consent-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .consent-item { font-size: 0.9em; color: #555; }
        .consent-icon { font-size: 1.2em; color: #27ae60; margin-right: 5px; }

        /* Form Styles */
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50; }
        select, input { width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 1em; }
        
        /* Button Styles */
        .jspsych-btn {
            background-color: #2c3e50; 
            border-color: #2c3e50; 
            color: white;
            padding: 12px 24px;
            font-size: 1.05em;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .jspsych-btn:hover { background-color: #34495e; }

        /* Game Elements */
        .peer-stats { background:#f8f9fa; padding:15px; border-radius:8px; margin:15px 0; border: 1px solid #e9ecef; }
        .ai-status { padding: 10px; border-radius: 8px; font-weight:bold; text-align: center; margin-top: 10px; }
    </style>
</head>
<body></body>
<script>

    // --- CONFIGURATION ---
    // PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
    const GOOGLE_SCRIPT_URL = 'YOUR_GOOGLE_SCRIPT_URL_HERE'; 
    
    // Capture Prolific ID or generate random for testing
    const urlParams = new URLSearchParams(window.location.search);
    const subject_id = urlParams.get('PROLIFIC_PID') || 'DEMO_' + Math.floor(Math.random()*10000);

    const jsPsych = initJsPsych({
        on_finish: function() {
            // Replace with your Prolific Completion URL
            window.location = "https://app.prolific.co/submissions/complete?cc=YOUR_CODE";
        }
    });

    let timeline = [];
    
    // Global variables to store data
    let user_demographics = {};
    let total_score = 0;
    let ai_reliability = 0.95; // Starts at 95% accuracy

    // ==========================================
    // 1. INFORMED CONSENT (Clinical Style)
    // ==========================================
    const consent_trial = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div class="medical-card">
                <h1>CONFIIA Initiative: Research Protocol</h1>
                <p>Welcome. You are invited to participate in a simulation regarding <b>AI-assisted medical decision-making</b> under uncertainty.</p>
                
                <div class="highlight-box">
                    <strong>Study Objective:</strong> To understand how professionals interact with AI systems when accuracy fluctuates due to social dynamics.
                </div>

                <h3>Participant Guarantees</h3>
                <div class="consent-grid">
                    <div class="consent-item"><span class="consent-icon">‚úì</span> <strong>Anonymity:</strong> Only your Prolific ID is recorded. No IP addresses.</div>
                    <div class="consent-item"><span class="consent-icon">‚úì</span> <strong>No Risk:</strong> Standard web simulation. No sensitive content.</div>
                    <div class="consent-item"><span class="consent-icon">‚úì</span> <strong>Voluntary:</strong> You may withdraw at any time (payment is contingent on completion).</div>
                    <div class="consent-item"><span class="consent-icon">‚úì</span> <strong>Scientific Use:</strong> Data will be used for aggregated academic analysis.</div>
                </div>

                <p style="font-size: 0.85em; color: #7f8c8d; margin-top: 20px;">
                    By clicking "Accept Protocol", you declare you are over 18 years old and consent to participate in accordance with university ethical guidelines.
                </p>
            </div>
        `,
        choices: ['Accept Protocol & Enter Simulation'],
        data: { task: 'consent' }
    };
    timeline.push(consent_trial);

    // ==========================================
    // 2. DEMOGRAPHICS (Gamified as "Credentialing")
    // ==========================================
    const demographics_trial = {
        type: jsPsychSurveyHtmlForm,
        html: `
            <div class="medical-card">
                <h1>Physician Credentialing</h1>
                <p>To calibrate the simulation, please configure your operator profile.</p>
                
                <div class="form-group">
                    <label for="age">Year of Birth:</label>
                    <input type="number" id="age" name="age" min="1920" max="2006" placeholder="e.g., 1990" required>
                </div>

                <div class="form-group">
                    <label for="gender">Gender Identity:</label>
                    <select id="gender" name="gender" required>
                        <option value="" disabled selected>Select...</option>
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                        <option value="non_binary">Non-binary / Other</option>
                        <option value="prefer_not_to_say">Prefer not to say</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="ai_knowledge">Self-Reported AI Fluency:</label>
                    <select id="ai_knowledge" name="ai_knowledge" required>
                        <option value="" disabled selected>Select...</option>
                        <option value="low">Basic User (e.g., Siri, Maps)</option>
                        <option value="medium">Frequent User (e.g., ChatGPT, Work Tools)</option>
                        <option value="high">Expert/Technical (e.g., Coding, Data Science)</option>
                    </select>
                </div>

                <div class="warning-box">
                    <strong>Note:</strong> No medical knowledge is required. This study assesses strategic reasoning.
                </div>
            </div>
        `,
        button_label: "Generate Profile & Start",
        on_finish: function(data) {
            user_demographics = data.response;
        }
    };
    timeline.push(demographics_trial);

    // ==========================================
    // 3. INSTRUCTIONS (Evolutionary/Social Context)
    // ==========================================
    timeline.push({
        type: jsPsychInstructions,
        pages: [
            `<div class='medical-card'>
                <h1>Welcome to the University Hospital</h1>
                <p>You are part of a diagnostic unit with <b>3 other physicians</b> (simulated by the system).</p>
                <p>Your goal is to maximize your <b>Performance Points</b> over 5 Fiscal Years (Rounds).</p>
            </div>`,
            
            `<div class='medical-card'>
                <h3>The Tool: Medi-Net AI</h3>
                <p>The hospital has installed a powerful AI diagnostic system.</p>
                <ul>
                    <li>It is fast and usually accurate.</li>
                    <li><b>HOWEVER:</b> The AI requires human supervision ("Human-in-the-loop") to maintain its database quality.</li>
                </ul>
                <div class='warning-box'>
                    <strong>The Social Dilemma:</strong><br>
                    If everyone trusts the AI blindly, its quality degrades due to lack of feedback (The "Free-Rider" effect).<br>
                    If you <b>Audit</b> (check) the AI, you keep the system safe, but it takes time (fewer points for you).
                </div>
            </div>`
        ],
        show_clickable_nav: true,
        button_label_next: "Next >",
        button_label_previous: "< Back"
    });

    // ==========================================
    // 4. GAME LOOP (The Experiment)
    // ==========================================
    
    let generations = 5;
    
    // Initial fictitious peer strategies
    const peer_strategies = [
        { text: "Dr. Ross: Traditionalist (Manual only)", score: 50 },
        { text: "Dr. Chen: 'Blind Adopter' (Uses AI, no checks)", score: 80 }, 
        { text: "Dr. Nowak: Auditor (Uses AI, verifies output)", score: 60 }
    ];

    for (let gen = 1; gen <= generations; gen++) {

        // Phase A: Social Leaderboard
        let leaderboard_trial = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                let ai_color = (ai_reliability > 0.8) ? "#27ae60" : "#c0392b";
                let ai_bg = (ai_reliability > 0.8) ? "#d5f5e3" : "#fadbd8";
                let ai_text = (ai_reliability > 0.8) ? "STABLE" : "UNSTABLE (High Error Risk)";
                
                return `
                    <div class="medical-card" style="text-align:center">
                        <h2>Fiscal Year ${gen} of ${generations}</h2>
                        
                        <div class="peer-stats" style="text-align:left">
                            <h4>Department Report (Previous Year):</h4>
                            <p>ü©∫ ${peer_strategies[0].text} ‚Äî Pts: <b>${peer_strategies[0].score}</b></p>
                            <p>üöÄ ${peer_strategies[1].text} ‚Äî Pts: <b>${peer_strategies[1].score}</b></p>
                            <p>‚öñÔ∏è ${peer_strategies[2].text} ‚Äî Pts: <b>${peer_strategies[2].score}</b></p>
                        </div>

                        <div class="ai-status" style="border: 2px solid ${ai_color}; background-color: ${ai_bg}; color: ${ai_color};">
                            AI System Status: ${ai_text}
                        </div>

                        <p style="margin-top:20px">Choose your strategy for this year:</p>
                    </div>
                `;
            },
            choices: ['Traditionalist (Ignore AI)', 'Skeptical Auditor (Verify AI)', 'Blind Adopter (Trust AI)'],
            data: { task: 'strategy_selection', generation: gen }
        };

        // Phase B: Feedback & Evolutionary Update
        let feedback_trial = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                let choice_idx = jsPsych.data.get().last(1).values()[0].response;
                let choice_name = ['Traditionalist', 'Auditor', 'Blind Adopter'][choice_idx];
                
                let round_points = 0;
                let message = "";
                let style_class = "";

                // Game Theory Logic
                if (choice_idx === 0) { // Traditionalist
                    round_points = 50;
                    message = "You relied on manual diagnosis. Safe, but slow. Average income.";
                    style_class = "color: #7f8c8d";
                } else if (choice_idx === 1) { // Auditor
                    round_points = 70;
                    message = "You used AI but verified the data. Good work. You helped maintain system integrity.";
                    ai_reliability = Math.min(1.0, ai_reliability + 0.05); // Public Good Contribution
                    style_class = "color: #2980b9";
                } else { // Blind Adopter (Free Rider)
                    let crash = Math.random() > ai_reliability;
                    if (crash) {
                        round_points = 10;
                        message = "CRITICAL FAILURE! The AI hallucinated a diagnosis. Since you didn't check, the patient was harmed. Malpractice suit filed.";
                        style_class = "color: #c0392b; font-weight:bold";
                    } else {
                        round_points = 100;
                        message = "Success! The AI was correct and you processed 3x more patients than your peers. Maximum Bonus.";
                        style_class = "color: #27ae60; font-weight:bold";
                    }
                    ai_reliability -= 0.15; // Public Good Degradation
                }

                total_score += round_points;

                // Simulate Social Contagion (Peers copy success)
                // If the player (or the Blind Adopter peer) made huge profits, others might switch to risky behavior
                if(choice_idx === 2 && round_points === 100) {
                    peer_strategies[0].text = "Dr. Ross: Switched to Blind Adopter (Copied)";
                    peer_strategies[0].score = 95; 
                } else if (choice_idx === 2 && round_points === 10) {
                    // If Blind Adopter failed, peers become conservative
                    peer_strategies[0].text = "Dr. Ross: Remains Traditionalist";
                    peer_strategies[0].score = 55;
                }

                return `
                    <div class="medical-card" style="text-align:center">
                        <h2>Year End Results</h2>
                        <h3 style="${style_class}">${message}</h3>
                        <div style="font-size:24px; margin:20px; padding:15px; background:#f8f9fa; border-radius:8px; border:1px solid #ddd;">
                            Points Earned: <b>${round_points}</b>
                        </div>
                        <p style="color:#555;">Projected AI Health for next year: ${(ai_reliability*100).toFixed(0)}%</p>
                    </div>
                `;
            },
            choices: ['Start Next Fiscal Year >']
        };

        timeline.push(leaderboard_trial);
        timeline.push(feedback_trial);
    }

    // ==========================================
    // 5. SAVE DATA & END
    // ==========================================
    timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div class="medical-card"><h3>Saving data to secure server...</h3><p>Please wait.</p></div>`,
        choices: [],
        on_load: function() {
            // Combine demographics + game data
            let final_data_packet = {
                subject_id: subject_id,
                age: user_demographics.age,
                gender: user_demographics.gender,
                ai_literacy: user_demographics.ai_knowledge,
                final_score: total_score,
                final_ai_health: ai_reliability,
                timestamp: new Date().toISOString()
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(final_data_packet)
            }).then(() => {
                jsPsych.finishTrial();
            }).catch(err => {
                console.error("Save error:", err);
                // Finish anyway so user gets their completion code
                jsPsych.finishTrial();
            });
        }
    });

    // Final Screen
    timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div class="medical-card">
                <h1>Simulation Complete</h1>
                <p>Thank you for participating in the CONFIIA Project.</p>
                <p>Your Final Score: <b>${total_score}</b></p>
                <p>You will be redirected to Prolific in 3 seconds.</p>
            </div>
        `,
        choices: ['Finish Manually'],
        trial_duration: 3000
    });

    jsPsych.run(timeline);

</script>
</html>
